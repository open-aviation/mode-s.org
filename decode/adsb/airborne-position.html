<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

  <meta name="author" content="Junzi Sun">


  <title>The 1090MHz Riddle</title>
  <style type="text/css">code{white-space: pre;}</style>



  <link rel="stylesheet" href="../bootstrap.min.css">
  <link rel="stylesheet" href="../style.css">

  <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>

<link href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet">

</head>
<body>

<div class="container">

<div class="d-flex flex-row align-items-end">
	<div>
		<h1 class="title">The 1090MHz Riddle</h1>
		<div class="subtitle">An open-access book about decoding Mode-S and ADS-B data</div>
	</div>
	<div class='ml-auto chapter-nav'>
    <div class="author">By: <strong>Junzi Sun</strong> (<a href="http://junzis.com">junzis.com</a>)</div>
    <a href="http://mode-s.org" type="button" class="btn btn-sm btn-outline-dark btn-light">mode-s.org</a>
    <a href="../book-the_1090mhz_riddle-junzi_sun.pdf" type="button" class="btn btn-sm btn-outline-info">Download PDF</a>
	</div>
</div>

<hr>

<div class="row">
<div class="col-md-4 col-lg-3">
<nav>
  <h1>Chapters</h1>
  <ul>
    <li><a href="../index.html">Introduction</a></li>
    <li><a href="../adsb.html">ADS-B</a></li>
    <ul>
      <li><a href="../adsb/introduction.html">Basics</a></li>
      <li><a href="../adsb/identification.html">Aircraft Identification</a></li>
      <li><a href="../adsb/compact-position-report.html">Compact Position Reporting</a></li>
      <li><a href="../adsb/airborne-position.html">Airborne Position</a></li>
      <li><a href="../adsb/airborne-velocity.html">Airborne Velocity</a></li>
    </ul>
    <li><a href="../adsb/advance.html">Advanced ADS-B</a></li>
    <ul>
      <li><a href="../adsb/version.html">ADS-B Versions</a></li>
      <li><a href="../adsb/operation-status.html">Operation Status</a></li>
      <li><a href="../adsb/uncertainty.html">Uncertainty and Accuracy</a></li>
    </ul>
    <li><a href="../ehs.html">Enhanced Mode-S</a></li>
    <ul>
      <li><a href="../ehs/introduction.html">Basics</a></li>
      <li><a href="../ehs/bds20-identification.html">Aircraft Identification</a></li>
      <li><a href="../ehs/bds40-intention.html">Aircraft Intention</a></li>
      <li><a href="../ehs/bds50-track-n-turn.html">Track and Turn</a></li>
      <li><a href="../ehs/bds60-airspeed.html">Airspeed and Heading</a></li>
    </ul>
  </ul>
</nav>
<hr>
<nav id="TOC">
<h1>In this page</h1>
<ul>
<li><a href="#airborne-positions">Airborne Positions</a><ul>
<li><a href="#globally-unambiguous-position-decoding-with-two-messages">Globally unambiguous position (decoding with two messages)</a><ul>
<li><a href="#odd-or-even-message">odd&quot; or even message?</a></li>
<li><a href="#the-cpr-representation-of-coordinates">The CPR representation of coordinates</a></li>
<li><a href="#calculate-the-latitude-index-j">Calculate the latitude index j</a></li>
<li><a href="#calculate-latitude">Calculate latitude</a></li>
<li><a href="#check-the-latitude-zone-consistency">Check the latitude zone consistency</a></li>
<li><a href="#calculate-longitude">Calculate longitude</a></li>
<li><a href="#calculate-altitude">Calculate altitude</a></li>
<li><a href="#the-final-position">The final position</a></li>
</ul></li>
<li><a href="#locally-unambiguous-position-decoding-with-one-message">Locally unambiguous position (decoding with one message)</a><ul>
<li><a href="#the-reference-position">The reference position</a></li>
<li><a href="#calculate-dlat">Calculate dLat</a></li>
<li><a href="#calculate-the-latitude-index-j-1">Calculate the latitude indexj</a></li>
<li><a href="#calculate-latitude-1">Calculate latitude</a></li>
<li><a href="#calculate-dlon">Calculate dLon</a></li>
<li><a href="#calculate-longitude-index-m">Calculate longitude index m</a></li>
<li><a href="#calculate-longitude-1">Calculate longitude</a></li>
<li><a href="#example">Example</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
</div>
<div class="col-md-8 col-lg-9 maintext">
<h1 id="airborne-positions">Airborne Positions</h1>
<p>An aircraft airborne position message has downlink format <code>17</code> (or <code>18</code>) with type code from <code>9</code> to <code>18</code></p>
<p>Messages are composed as follows:</p>
<pre><code>+-----------+---------+---------+----------------------------------+
| MSG bits  | # bits  | Abbr    | Content                          |
+===========+=========+=========+==================================+
| 1-5       | 5       | DF      | Downlink format                  |
+-----------+---------+---------+----------------------------------+
| 33-37     | 5       | TC      | Type code                        |
+-----------+---------+---------+----------------------------------+
| 38-39     | 2       | SS      | Surveillance status              |
+-----------+---------+---------+----------------------------------+
| 40        | 1       | NICsb   | NIC supplement-B                 |
+-----------+---------+---------+----------------------------------+
| 41-52     | 12      | ALT     | Altitude                         |
+-----------+---------+---------+----------------------------------+
| 53        | 1       | T       | Time                             |
+-----------+---------+---------+----------------------------------+
| 54        | 1       | F       | CPR odd/even frame flag          |
+-----------+---------+---------+----------------------------------+
| 55-71     | 17      | LAT-CPR | Latitude in CPR format           |
+-----------+---------+---------+----------------------------------+
| 72-88     | 17      | LON-CPR | Longitude in CPR format          |
+-----------+---------+---------+----------------------------------+</code></pre>
<p>Two types of the position messages (odd and even frames) are broadcast alternately. There are two different ways to decode an airborne position base on these messages:</p>
<ol>
<li><p>Unknown position, using both type of messages (aka globally unambiguous position)</p></li>
<li><p>Knowing previous position, using only one message (aka locally unambiguous position)</p></li>
</ol>
<p>Note: The definition of functions <code>NL(lat)</code>, <code>floor(x)</code>, and <code>mod(x,y)</code> are described in the CPR chapter.</p>
<h2 id="globally-unambiguous-position-decoding-with-two-messages">Globally unambiguous position (decoding with two messages)</h2>
<h3 id="odd-or-even-message">odd&quot; or even message?</h3>
<p>For each frame, bit 54 determines whether it is an “odd” or “even” frame: :</p>
<pre><code>0 -&gt; Even frame
1 -&gt; Odd frame</code></pre>
<p>For example, the two following messages are received:</p>
<pre><code>8D40621D58C382D690C8AC2863A7
8D40621D58C386435CC412692AD6

|    | ICAO24 |      DATA      |  CRC   |
|----|--------|----------------|--------|
| 8D | 40621D | 58C382D690C8AC | 2863A7 |
| 8D | 40621D | 58C386435CC412 | 692AD6 |</code></pre>
<p>The payload data in binary formation:</p>
<pre><code>| DATA                                                                       |
|============================================================================|
| TC    | ... | ALT          | T | F | CPR-LAT           | CPR-LON           |
|-------|-----|--------------|---|---|-------------------|-------------------|
| 01011 | 000 | 110000111000 | 0 | 0 | 10110101101001000 | 01100100010101100 |
| 01011 | 000 | 110000111000 | 0 | 1 | 10010000110101110 | 01100010000010010 |</code></pre>
<p>In both messages we can find <code>DF=17</code> and <code>TC=11</code>, with the same ICAO24 address <code>40621D</code>. So, those two frames are valid for decoding the positions of this aircraft. Assume the first message is the newest message received.</p>
<h3 id="the-cpr-representation-of-coordinates">The CPR representation of coordinates</h3>
<pre><code>| F | CPR Latitude      | CPR Longitude     |
|---|-------------------|-------------------|
| 0 | 10110101101001000 | 01100100010101100 |  -&gt; newest
| 1 | 10010000110101110 | 01100010000010010 |
|---|-------------------|-------------------|

In decimal:

|---|-------------------|-------------------|
| 0 | 93000             | 51372             |
| 1 | 74158             | 50194             |
|---|-------------------|-------------------|

CPR_LAT_EVEN: 93000 / 131072 -&gt; 0.7095
CPR_LON_EVEN: 51372 / 131072 -&gt; 0.3919
CPR_LAT_ODD:  74158 / 131072 -&gt; 0.5658
CPR_LON_ODD:  50194 / 131072 -&gt; 0.3829</code></pre>
<p>Since CPR latitude and longitude are encoded in 17 bits, 131072 (2^17) is the maximum value.</p>
<h3 id="calculate-the-latitude-index-j">Calculate the latitude index j</h3>
<p>Use the following equation:</p>
<p><span class="math display">\[j = floor \left( 59 \cdot \mathrm{Lat}_\mathrm{cprEven} - 60 \cdot \mathrm{Lat}_\mathrm{cprOdd} + \frac{1}{2}  \right)\]</span></p>
<p>where <span class="math inline">\(j\)</span> is set 8.</p>
<h3 id="calculate-latitude">Calculate latitude</h3>
<p>First, two constants will be used:</p>
<p><span class="math display">\[\begin{split}
    \mathrm{dLat}_\mathrm{even} &amp;= \frac{360}{4 \cdot NZ} = \frac{360}{60} \\
    \mathrm{dLat}_\mathrm{odd} &amp;= \frac{360}{4 \cdot NZ - 1}  = \frac{360}{59}
  \end{split}\]</span></p>
<p>Then we can use the following equations to compute the relative latitudes:</p>
<p><span class="math display">\[\begin{split}
    \mathrm{Lat}_\mathrm{even} &amp;= \mathrm{dLat}_\mathrm{even} \cdot [mod(j, 60) + \mathrm{Lat}_\mathrm{cprEven}] \\
    \mathrm{Lat}_\mathrm{odd} &amp;= \mathrm{dLat}_\mathrm{odd} \cdot [mod(j, 59) + \mathrm{Lat}_\mathrm{cprOdd}]
  \end{split}\]</span></p>
<p>For the southern hemisphere, values will fall from 270 to 360 degrees. We need to make sure the latitude is within the range <code>[-90, +90]</code>:</p>
<p><span class="math display">\[\begin{split}
    \mathrm{Lat}_\mathrm{even} &amp;= \mathrm{Lat}_\mathrm{even} - 360  \quad \text{if } (\mathrm{Lat}_\mathrm{even} \geq 270) \\
    \mathrm{Lat}_\mathrm{odd} &amp;= \mathrm{Lat}_\mathrm{odd} - 360  \quad \text{if } (\mathrm{Lat}_\mathrm{odd} \geq 270)
  \end{split}\]</span></p>
<p>Final latitude is chosen depending on the time stamp of the frames–the newest one is used:</p>
<p><span class="math display">\[\mathrm{Lat} =
  \begin{cases}
   \mathrm{Lat}_\mathrm{even}     &amp; \text{if } (T_\mathrm{even} \geq T_\mathrm{odd}) \\
   \mathrm{Lat}_\mathrm{odd}     &amp; \text{else}
  \end{cases}\]</span></p>
<p>In the example: :</p>
<pre><code>Lat_EVEN = 52.25720214843750
Lat_ODD  = 52.26578017412606
Lat = Lat_EVEN = 52.25720</code></pre>
<h3 id="check-the-latitude-zone-consistency">Check the latitude zone consistency</h3>
<p>Compute <code>NL(Lat_E)</code> and <code>NL(Lat_O)</code>. If not the same, two positions are located at different latitude zones. Computation of a global longitude is not possible. Exit the calculation and wait for new messages. If two values are the same, we proceed to longitude calculation.</p>
<h3 id="calculate-longitude">Calculate longitude</h3>
<p>If the even frame comes latest <code>T_EVEN &gt; T_ODD</code>:</p>
<p><span class="math display">\[\begin{split}
    ni &amp;= max \left( NL(\mathrm{Lat}_\mathrm{even}), 1 \right) \\
    \mathrm{dLon} &amp;= \frac{360}{ni} \\
    m &amp;= floor \left\{ Lon_\mathrm{cprEven} \cdot [NL(\mathrm{Lat}_\mathrm{even})-1] - Lon_\mathrm{cprOdd} \cdot NL(\mathrm{Lat}_\mathrm{even}) + \frac{1}{2}  \right\} \\
    \mathrm{Lon} &amp;= \mathrm{dLon} \cdot \left( mod(m, ni) + Lon_\mathrm{cprEven} \right)
  \end{split}\]</span></p>
<p>In case where the odd frame comes latest <code>T_EVEN &lt; T_ODD</code>:</p>
<p><span class="math display">\[\begin{split}
    ni &amp;= max \left( NL(\mathrm{Lat}_\mathrm{odd})-1, 1 \right) \\
    \mathrm{dLon} &amp;= \frac{360}{ni} \\
    m &amp;= floor \left\{ Lon_\mathrm{cprEven} \cdot [NL(\mathrm{Lat}_\mathrm{odd})-1] - Lon_\mathrm{cprOdd} \cdot NL(\mathrm{Lat}_\mathrm{odd}) + \frac{1}{2}  \right\} \\
    \mathrm{Lon} &amp;= \mathrm{dLon} \cdot \left( mod(m, ni) + Lon_\mathrm{cprOdd} \right)
  \end{split}\]</span></p>
<p>if the result is larger than 180 degrees:</p>
<p><span class="math display">\[\mathrm{Lon} = \mathrm{Lon} - 360  \quad \text{if } (\mathrm{Lon} \geq 180)\]</span></p>
<p>In the example: :</p>
<pre><code>Lon:  3.91937</code></pre>
<p>Here is a Python implementation: <a href="https://github.com/junzis/pyModeS/blob/faf4313/pyModeS/adsb.py#L166" class="uri">https://github.com/junzis/pyModeS/blob/faf4313/pyModeS/adsb.py#L166</a></p>
<h3 id="calculate-altitude">Calculate altitude</h3>
<p>The altitude of the aircraft is much easier to compute from the data frame. The bits in the altitude field (either odd or even frame) are as follows: :</p>
<pre><code>1100001 1 1000
        ^
       Q-bit</code></pre>
<p>This Q-bit (bit 48) indicates whether the altitude is encoded in multiples of 25 or 100 ft (0: 100 ft, 1: 25 ft).</p>
<p>For Q = 1, we can calculate the altitude as follows:</p>
<p>First, remove the Q-bit :</p>
<pre><code>N = 1100001 1000 =&gt; 1560 (in decimal)</code></pre>
<p>The final altitude value will be:</p>
<p><span class="math display">\[Alt = N \cdot 25 - 1000 \quad \text{(ft.)}\]</span></p>
<p>In this example, the altitude at which the aircraft is flying is: :</p>
<pre><code>1560 * 25 - 1000 = 38000 ft.</code></pre>
<p>Note that the altitude has the accuracy of +/- 25 ft when the Q-bit is 1, and the value can represent altitudes from -1000 to +50175 ft.</p>
<h3 id="the-final-position">The final position</h3>
<p>Finally, we have all three components (latitude/longitude/altitude) of the aircraft position: :</p>
<pre><code>LAT: 52.25720 (degrees N)
LON:  3.91937 (degrees E)
ALT:    38000 ft</code></pre>
<h2 id="locally-unambiguous-position-decoding-with-one-message">Locally unambiguous position (decoding with one message)</h2>
<p>This method gives the possibility of decoding aircraft using only one message knowing a reference position. This method computes the latitude index (j) and the longitude index (m) based on such reference, and can be used with either type of the messages.</p>
<h3 id="the-reference-position">The reference position</h3>
<p>The reference position should be close to the actual position (eg. position of aircraft previously decoded, or the location of ADS-B antenna), and must be <strong>within a 180 NM</strong> range.</p>
<h3 id="calculate-dlat">Calculate dLat</h3>
<p><span class="math display">\[dLat =
  \begin{cases}
   \frac{360}{4 \cdot NZ} = \frac{360}{60}          &amp; \text{if even message}  \\
   \frac{360}{4 \cdot NZ - 1}  = \frac{360}{59}     &amp; \text{if odd message}
  \end{cases}\]</span></p>
<h3 id="calculate-the-latitude-index-j-1">Calculate the latitude indexj</h3>
<p><span class="math display">\[j = floor \left (\frac{\mathrm{Lat}_{ref}}{dLat} \right) + floor \left( \frac{mod(\mathrm{Lat}_{ref}, dLat)}{dLat}  - \mathrm{Lat}_\mathrm{cpr}  + \frac{1}{2} \right)\]</span></p>
<h3 id="calculate-latitude-1">Calculate latitude</h3>
<p><span class="math display">\[\mathrm{Lat} = dLat \cdot (j + \mathrm{Lat}_\mathrm{cpr})\]</span></p>
<h3 id="calculate-dlon">Calculate dLon</h3>
<p><span class="math display">\[\mathrm{dLon} =
  \begin{cases}
   \frac{360}{NL(Lat)}    &amp; \text{if } NL(Lat) &gt; 0  \\
   360                    &amp; \text{if } NL(Lat) = 0
  \end{cases}\]</span></p>
<h3 id="calculate-longitude-index-m">Calculate longitude index m</h3>
<p><span class="math display">\[m = floor \left( \frac{Lon_{ref}}{\mathrm{dLon}} \right) + floor \left( \frac{mod(Lon_{ref}, \mathrm{dLon})}{\mathrm{dLon}}  - Lon_\mathrm{cpr}  + \frac{1}{2}  \right)\]</span></p>
<h3 id="calculate-longitude-1">Calculate longitude</h3>
<p><span class="math display">\[Lon = \mathrm{dLon} \cdot (m + Lon_\mathrm{cpr})\]</span></p>
<h3 id="example">Example</h3>
<p>For the same example message:</p>
<pre><code>8D40621D58C382D690C8AC2863A7

Reference position:
  LAT: 52.258
  LON:  3.918</code></pre>
<p>The structure of the message is:</p>
<pre><code>8D40621D58C382D690C8AC2863A7

|    | ICAO24 |      DATA      |  CRC   |
|----|--------|----------------|--------|
| 8D | 40621D | 58C382D690C8AC | 2863A7 |


Data in binary:

| DATA                                                                       |
|============================================================================|
| TC    | ... | ALT          | T | F | CPR-LAT           | CPR-LON           |
|-------|-----|--------------|---|---|-------------------|-------------------|
| 01011 | 000 | 110000111000 | 0 | 0 | 10110101101001000 | 01100100010101100 |


CPR representation:

| F | CPR Latitude      | CPR Longitude     |
|---|-------------------|-------------------|
| 0 | 10110101101001000 | 01100100010101100 |
|---|-------------------|-------------------|
|   | 93000 / 131072    | 51372 / 131072    |
|   | 0.7095            | 0.3919            |
|---|-------------------|-------------------|

d_lat:  6
j:      8
lat:    52.25720
m:      0
d_lon:  10
lon:    3.91937</code></pre>
</div>
</div>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-74700456-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-74700456-1');
</script>

</body>
</html>
